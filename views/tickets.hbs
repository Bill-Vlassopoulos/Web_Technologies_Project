<section class="eisitiria">
    <section class="tickets">
        <section class="orario">
            <h2>Ωράριο Λειτουργίας</h2>
            <h4>Δευτέρα: 9:00-15:00 & 17:00-21:00</h4>
            <h4>Τρίτη: 9:00-15:00 & 17:00-21:00</h4>
            <h4>Τετάρτη: 9:00-15:00 & 17:00-21:00</h4>
            <h4>Πέμπτη: 9:00-15:00 & 17:00-21:00</h4>
            <h4>Παρασκευή: 9:00-15:00 & 17:00-21:00</h4>
            <h4>Σάββατο: 9:00-15:00 & 17:00-21:00</h4>
            <h4>Κυριακή: 9:00-15:00 & 17:00-21:00</h4>
            <h4 class="timi">Κόστος απλής εισόδου: 10 ευρώ(ολόκληρο).</h4>
            <h4 class="timi2">Επιπλέον χρέωση για είσοδο σε περιοδική έκθεση: 4 ευρώ/αίθουσα.</h4>
        </section>
        <img src="http://www.vggallery.com/painting/f_0526.jpg" title="Self-Portrait with Straw Hat">
    </section>

    <section class="tickets">
        <div class="kratisi">
            <h2>Αγορά Εισιτηρίων</h2>
            <form method="get" action="/buy-tickets" class="kratisi-eis">
                <div class="plithos">
                    <label for="quantity">Πλήθος Εισιτηρίων:</label>
                    <input type="number" id="quantity" name="quantity" min="1" max="5" value="1" required>
                </div>
                <input type="button" id="elegxos" value="Επεξεργασία Εισιτηρίων" onclick="editTickets()">
            </form>

            <div class="ksechoristo-ticket">
                <form method="post" class="ticket-form" action="/submit">
                    <h2>Εισιτήριο #1</h2>
                    <div class="imerominia">
                        <label for="imerom1">Ημερομηνία:</label>
                        <input type="date" id="imerom1" name="imerom1" class="imerom" required>
                    </div>
                    <div class="hour">
                        <label for="ora1">Ώρα:</label>
                        <select name="ora1" id="ora1" class="ora" required>
                            <option value="1" selected>9:00-11:00</option>
                            <option value="2">11:00-13:00</option>
                            <option value="3">13:00-15:00</option>
                            <option value="4">17:00-19:00</option>
                            <option value="5">19:00-21:00</option>
                        </select>
                    </div>
                    <div class="eidiki">
                        <label for="katigoria1">Ειδική Κατηγορία:</label>
                        <select class="katig" name="katigoria1" id="katigoria1" onchange="calculate_cost(this)">
                            <option value="" selected>Καμία</option>
                            <option value="foititis">Φοιτητής-50%</option>
                            <option value="disabled">ΑΜΕΑ-50%</option>
                            <option value="polyteknoi">Πολύτεκνοι-25%</option>
                            <option value="paidia">Παιδιά κάτω των 12 ετών-Δωρεάν</option>
                        </select>
                    </div>
                    <div class="ektheseis">
                        <label>Έκθεση</label>
                        <div>
                            <p>Περιοδική έκθεση 1</p>
                        </div>
                        <div>
                            <p>Περιοδική έκθεση 2</p>
                        </div>
                        <div>
                            <p>Περιοδική έκθεση 3</p>
                        </div>
                    </div>
                    <span class="kostos">Κόστος: <span id="kostos-eis1">10</span>ευρώ</span>
                </form>
            </div>
        </div>

        <div class="episkeptis">
            <h2>Στοιχεία Επισκέπτη</h2>
            <form method="post" action="/submit" class="agora-ticket ticket-form">
                <div class="name">
                    <label for="onoma">Ονοματεπώνυμο</label>
                    <input type="text" id="onoma" name="onoma" placeholder="Oνοματεπώνυμo.." required>
                </div>
                <div class="email">
                    <label for="mail">Email</label>
                    <input type="email" id="mail" name="mail" placeholder="example@gmail.com" required>
                </div>
                <div class="phone-number">
                    <label for="phone">Τηλέφωνο</label>
                    <input type="tel" id="phone" name="phone" placeholder="Aριθμός τηλεφώνου.." pattern="[0-9]{10}"
                        required>
                </div>
            </form>
            <span class="finalCost">Συνολικό Κόστος: <span id="kostos-teliko">10</span>ευρώ </span>
            <p>*Η πληρωμή των εισιτηρίων γίνεται με την υπόδειξη του αποδεικτικού που προσκομίσατε στο προσωπικό σας
                email κατά την είσοδό σας στην πινακοθήκη. Σε περίπτωση μειωμένου εισιτηρίου κατηγορίας φοιτητή είναι
                απαραίτητη η υπόδειξη της φοιτητικής σας ταυτότητας.</p>
        </div>
    </section>
</section>

<script>
    const periodikes_ektheseis = {{{ ektheseis }}}

    // JavaScript to set the minimum date
    const datePickers = document.querySelectorAll(".imerominia input[type='date']");
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0
    const year = today.getFullYear();

    // Set the min attribute to today's date in YYYY-MM-DD format
    const minDate = `${year}-${month}-${day}`;
    datePickers.forEach(picker => {
        picker.setAttribute('min', minDate);
    });

    function editTickets() {
        let quantity = document.getElementById('quantity').value;
        let ticketContainer = document.querySelector('.kratisi');
        let firstTicket = document.querySelector('.ksechoristo-ticket');

        // Remove any previously added tickets except the first one
        let existingTickets = document.querySelectorAll('.ksechoristo-ticket');
        existingTickets.forEach((ticket, index) => {
            if (index > 0) ticket.remove();
        });

        for (let i = 2; i <= quantity; i++) {
            let clone = firstTicket.cloneNode(true);
            clone.querySelector('h2').textContent = `Εισιτήριο #${i}`;
            let inputs = clone.querySelectorAll('input, select');
            inputs.forEach(input => {
                let newName = input.name.replace(/\d+$/, '') + i;
                let newId = input.id.replace(/\d+$/, '') + i;
                input.setAttribute('name', newName);
                input.setAttribute('id', newId);
            });
            let kostos = clone.querySelector('.kostos span');
            kostos.setAttribute('id', `kostos-eis${i}`);
            ticketContainer.appendChild(clone);
        }

        let kratisi = document.querySelector(".episkeptis");
        kratisi.style.display = 'flex';
        DateEventListener();
        editPeriodeikes();
        calculateFinalCost();
    }

    function editPeriodeikes() {
        let tickets = document.querySelectorAll('.ksechoristo-ticket');
        tickets.forEach(ticket => {
            ticket.style.display = 'flex';
            let ektheseisDivs = ticket.querySelectorAll('.ektheseis div');
            ektheseisDivs.forEach(ektheseisDiv => {
                ektheseisDiv.addEventListener('click', function (event) {
                    ektheseisDiv.classList.toggle('selected');
                    let cost_indiv = ticket.querySelector('.kostos span');
                    if (ektheseisDiv.classList.contains('selected')) {
                        cost_indiv.innerHTML = parseInt(cost_indiv.innerHTML) + 4;
                    } else {
                        cost_indiv.innerHTML = parseInt(cost_indiv.innerHTML) - 4;
                    }
                    calculateFinalCost();
                });
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        var stickyButton = document.createElement('div');
        stickyButton.className = 'sticky-button';
        stickyButton.innerHTML = '<input type="button" value="Ολοκλήρωση">';
        stickyButton.addEventListener('click', submitAllForms);
        document.body.appendChild(stickyButton);

        // Reset form values to default on page load
        resetFormValues();
    });

    function resetFormValues() {
        document.getElementById('quantity').value = 1;
        let firstTicket = document.querySelector('.ksechoristo-ticket');
        firstTicket.querySelectorAll('input[type="date"]').forEach(input => input.value = '');
        firstTicket.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
        });
        firstTicket.querySelectorAll('.ektheseis div').forEach(div => {
            div.classList.remove('selected');
        });
        document.getElementById('kostos-eis1').innerHTML = 10;
        document.querySelector('.agora-ticket').reset();
        document.getElementById('kostos-teliko').innerHTML = 10;
    }

    function findActiveExhibitions(date) {
        let activeExhibitions = [];
        periodikes_ektheseis.forEach(ekthesi => {
            if (new Date(ekthesi.imerominia_enarxis) <= date && new Date(ekthesi.imerominia_lixis) >= date) {
                activeExhibitions.push(ekthesi);
            }
        });
        return activeExhibitions;
    }

    function calculate_cost(selectElement) {
        let selectedValue = selectElement.value;
        let uniqueId = selectElement.id.replace(/\D/g, '');
        let cost_indiv = document.querySelector(`#kostos-eis${uniqueId}`);

        let cost = 10;
        if (selectedValue === "foititis" || selectedValue === "disabled") {
            cost = 5;
        } else if (selectedValue === "polyteknoi") {
            cost = 7.5;
        } else if (selectedValue === "paidia") {
            cost = 0;
        }

        cost_indiv.innerHTML = cost + calculateSelectedExhibitions(selectElement) * 4;
        calculateFinalCost();
    }

    function calculateSelectedExhibitions(selectElement) {
        let ticket = selectElement.closest('.ksechoristo-ticket');
        let selectedExhibitions = ticket.querySelectorAll('.ektheseis div.selected');
        return selectedExhibitions.length;
    }

    function calculateFinalCost() {
        let tickets = document.querySelectorAll('.ksechoristo-ticket');
        let finalCost = 0;
        tickets.forEach(ticket => {
            let cost = ticket.querySelector('.kostos span').innerHTML;
            finalCost += parseInt(cost);
        });
        document.querySelector('#kostos-teliko').innerHTML = finalCost;
    }

    function submitAllForms() {
        let forms = document.querySelectorAll('.ticket-form');
        let allValid = true;

        forms.forEach(form => {
            if (!form.checkValidity()) {
                allValid = false;
                form.reportValidity();
            }
        });

        if (allValid) {
            let formData = [];
            forms.forEach(form => {
                let formValues = {};
                let inputs = form.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.name !== "onoma" && input.name !== "mail" && input.name !== "phone") {
                        formValues[input.name.slice(0, -1)] = input.value;
                    } else {
                        formValues[input.name] = input.value;
                    }
                });
                if (form.querySelector(".ektheseis") !== null) {
                    let selectedExhibitions = form.querySelectorAll('.ektheseis .selected p');
                    formValues['periodikes_ektheseis'] = [];
                    selectedExhibitions.forEach(ekthesi => {
                        formValues['periodikes_ektheseis'].push(periodikes_ektheseis.find(ek => ek.onoma_ekthesis === ekthesi.innerHTML).id_ekthesis);
                    });
                }

                formData.push(formValues);
            });

            fetch('/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Forms submitted successfully!');
                        location.reload();
                    } else {
                        console.error('Failed to submit forms');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    }

    function DateEventListener() {
        let datePickers = document.querySelectorAll('.imerominia input[type="date"]');
        datePickers.forEach(datePicker => {
            datePicker.addEventListener('change', function (event) {
                let date = new Date(event.target.value);
                let activeExhibitions = findActiveExhibitions(date);
                let ticket = event.target.closest('.ksechoristo-ticket');
                let exhibitionsDivs = ticket.querySelectorAll('.ektheseis div');

                exhibitionsDivs.forEach(exhibitionDiv => {
                    exhibitionDiv.remove();
                });

                activeExhibitions.forEach(ekthesi => {
                    let div = document.createElement('div');
                    div.innerHTML = `<p>${ekthesi.onoma_ekthesis}</p>`;
                    ticket.querySelector('.ektheseis').appendChild(div);
                });

                editPeriodeikes();
            });
        });
    }
</script>